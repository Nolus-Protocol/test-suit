stages:
  - prep
  - test

default:
  image: node:16.14.2-alpine

env-prep:
  variables:
    FEEDERS_FILE: "feeders.json"
    ACCOUNTS_DIR: "./accounts"
    NOLUS_DEV_NET: "https://net-dev.nolus.io:26612"
  stage: prep
  only:
    - schedules
  before_script:
    - apk update && apk add bash
    - apk --no-cache add curl
    - apk --no-cache add jq
  script:
    - yarn prepare-env-dev --mnemonic-faucet "$FAUCET_MNEMONIC_DEV"
        --mnemonic-contracts-owner "$SMART_CONTRACTS_ADMIN_MNEMONIC"
        --token-type "JOB-TOKEN" --token-value "$CI_JOB_TOKEN" --tag "$COSMZONE_PREFERRED_TAG"
        --test-transfer "$TEST_TRANSFER_PIPELINE" --test-oracle "$TEST_ORACLE_PIPELINE"
        --test-staking "$TEST_STAKING_PIPELINE" --test-borrower "$TEST_BORROWER_PIPELINE"
        --test-lender "$TEST_LENDER_PIPELINE" --test-treasury "$TEST_TREASURY_PIPELINE"
        --test-vesting "$TEST_VESTING_PIPELINE" --test-gov "$TEST_GOV_PIPELINE"
    - yarn save-feeders --accounts-dir "$ACCOUNTS_DIR" --feeders-file "$FEEDERS_FILE" --nolus-net "$NOLUS_DEV_NET"
  artifacts:
    paths:
    - .env
    - $FEEDERS_FILE

test:
  stage: test
  only:
    - schedules
  before_script:
    - apk update && apk add bash
  script:
    - npm config set //registry.npmjs.org/:_authToken ${NPM_TOKEN}
    - yarn install
    - yarn run test

